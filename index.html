<!DOCTYPE html>
<html>
<head>
    <title>Match Calendar</title>
    <link rel="icon" href="images/favicon.png">

    <link rel="stylesheet" href="bower_components/foundation/css/foundation.css"/>
    <link rel="stylesheet" href="css/style.css"/>
</head>
<body>
<a href="http://www.reddit.com/r/ultrahardcore"><img id="banner" src="images/banner.png"></a>
<table id="options">
    <tr>
        <th>Clock Cycle</th>
        <th><a id="time_is_link" href="http://time.is/">Current Time</a></th>
        <th>Time Zone</th>
    </tr>
    <tr>
        <td>
            <select id="cycle">
                <option value="24h">24 Hours</option>
                <option value="12h">12 Hours</option>
            </select>
        </td>
        <td><span id="time">Syncing with time.is...</span></td>
        <td>
            <select id="zone">
                <option value="+00:00">UTC +00:00</option>
                <option value="-12:00">UTC -12:00</option>
                <option value="-11:00">UTC -11:00</option>
                <option value="-10:00">UTC -10:00</option>
                <option value="-09:00">UTC -09:00</option>
                <option value="-08:00">UTC -08:00</option>
                <option value="-07:00">UTC -07:00</option>
                <option value="-06:00">UTC -06:00</option>
                <option value="-05:00">UTC -05:00</option>
                <option value="-04:00">UTC -04:00</option>
                <option value="-03:00">UTC -03:00</option>
                <option value="-02:00">UTC -02:00</option>
                <option value="-01:00">UTC -01:00</option>
                <option value="+01:00">UTC +01:00</option>
                <option value="+02:00">UTC +02:00</option>
                <option value="+03:00">UTC +03:00</option>
                <option value="+04:00">UTC +04:00</option>
                <option value="+05:00">UTC +05:00</option>
                <option value="+06:00">UTC +06:00</option>
                <option value="+07:00">UTC +07:00</option>
                <option value="+08:00">UTC +08:00</option>
                <option value="+09:00">UTC +09:00</option>
                <option value="+10:00">UTC +10:00</option>
                <option value="+11:00">UTC +11:00</option>
                <option value="+12:00">UTC +12:00</option>
            </select>
        </td>
    </tr>
</table>
<table id="matches"></table>
<span id="UTC_za00" style="display: none"></span>
<script type="text/javascript">
    time_is_widget.init({UTC_za00: {}});
</script>
<script type="text/javascript">
    var matches = [];
    var time = moment();
    var table = document.getElementById("matches");
    var cycle = document.getElementById("cycle");
    var zone = document.getElementById("zone");

    cycle.value = getOption("cycle", "24h");
    zone.value = getOption("zone", "+00:00");
    cycle.onchange = reload;
    zone.onchange = reload;

    var timeFormat = cycle.value == "24h" ? "HH:mm:ss" : "hh:mm:ss A";
    var dateFormat = cycle.value == "24h" ? "MMMM Do - HH:mm" : "MMMM Do - hh:mm A";

    updateTime();
    updateMatches();
    updateCountdowns();

    function updateMatches() {
        $.ajax({
            type: "GET",
            url: "http://www.reddit.com/r/ultrahardcore/search.json?q=flair%3AUpcoming_Match&restrict_sr=on&sort=new&limit=100",
            success: function (response) {
                matches = [];
                response.data.children.forEach(function (r) {
                    var match = {};
                    match.date = moment.utc(/\w+ \d+ \d+:\d+/.exec(r.data.title), "MMM DD HH:mm");
                    match.date.zone(zone.value);
                    match.title = r.data.title.substring(r.data.title.indexOf("-") + 2);
                    match.url = r.data.url;
                    match.opens = getOpens(match.date, r.data.selftext);
                    if (match.date.diff(time) > 0) {
                        matches.push(match);
                    }
                });
                matches.sort(function (a, b) {
                    return a.date.diff(b.date);
                });
                table.innerHTML = "<tr><th>Date</th><th>Match</th><th title='EXPERIMENTAL: Post must contain \"Whitelist off:\"'>Opens*</th><th>Starts</th></tr>";
                matches.forEach(function (m) {
                    table.innerHTML += createRow(m);
                });
            }
        });
        setTimeout(updateMatches, 60000);
    }

    function updateCountdowns() {
        for (var i = 0; i < matches.length; i++) {
            var match = matches[i];
            var row = table.rows[i + 1];
            if (match.opens) row.cells[2].innerHTML = getRemaining(match.opens, "Opened");
            row.cells[3].innerHTML = getRemaining(match.date, "Started");
        }
        setTimeout(updateCountdowns, 10);
    }

    function updateTime() {
        var widget = document.getElementById("UTC_za00");
        var match = /\d+:\d+:\d+/.exec(widget.innerHTML);
        time = moment.utc(match, "HH:mm:ss");
        time.zone(zone.value);
        document.getElementById("time").innerHTML = time.format(timeFormat);
        setTimeout(updateTime, 10);
    }

    function getOpens(date, text) {
        if (text.indexOf("Whitelist off") > -1) {
            var opens = moment.utc(date);
            var time = text.substring(text.indexOf("Whitelist off"));
            if (/\d+:\d+/.test(time)) {
                var r = /(\d+):(\d+)/.exec(time);
                opens.set("hour", opens.get("hour") < parseInt(r[1]) ? 0 : r[1]);
                opens.set("minute", r[2]);
            }
            else if (/\d+/.test(time)) {
                opens.subtract("minutes", /\d+/.exec(time));
            }
            opens.zone(zone.value);
            return opens;
        }
    }

    function getRemaining(date, under) {
        var remaining = date.diff(time, "seconds");
        if (remaining < 0) return under;
        var formatted = "";
        var days = Math.floor(remaining / 86400);
        var hours = Math.floor((remaining - days * 86400) / 3600);
        var minutes = Math.floor((remaining - days * 86400 - hours * 3600) / 60);
        var seconds = Math.floor(remaining - days * 86400 - hours * 3600 - minutes * 60);
        formatted += (days < 10 ? "0" : "") + days;
        formatted += (hours < 10 ? ":0" : ":") + hours;
        formatted += (minutes < 10 ? ":0" : ":") + minutes;
        formatted += (seconds < 10 ? ":0" : ":") + seconds;
        return formatted;
    }

    function createRow(match) {
        var row = "<tr>";
        row += "<td class='date'>" + match.date.format(dateFormat) + "</td>";
        row += "<td class='match'><a href='" + match.url + "'>" + match.title + "</a></td>";
        row += "<td class='opens'>-</td>";
        row += "<td class='starts'>-</td>";
        return row + "</tr>"
    }

    function reload() {
        location.search = "?cycle=" + cycle.value + "&zone=" + zone.value;
    }

    function getOption(name, def) {
        var options = location.search.substring(1).split("&");
        var option = def;
        options.forEach(function (o) {
            if (o.indexOf(name) > -1) {
                option = o.substring(o.indexOf("=") + 1);
            }
        });
        return option;
    }
</script>

<script src="bower_components/angular/angular.min.js"></script>
<script src="bower_components/angular-foundation/mm-foundation-tpls.min.js"></script>
<script src="bower_components/moment/min/moment.min.js"></script>
</body>
</html>